import multiprocessing
import math
import scipy
import scipy.spatial
import ctypes
import os
import PIL.Image
import random
import setproctitle
import sys
import time
import traceback
def raise_error(location, traceback_output):
    with open("errors.txt", "a") as file:
        file.write("Error at " + location + "\n\n" + traceback_output + "\n\n\n")
def assign_biomes(piece_range, biome_origin_dots, local_dots):
    try:
        tree = scipy.spatial.KDTree([(dot.x, dot.y) for dot in biome_origin_dots])
        for i in [index for index in range(piece_range[0], piece_range[1])
        if local_dots[index].type == "Land"]:
            dot = local_dots[i]
            dots[i] = Dot(dot.x, dot.y, biome_origin_dots[tree.query((dot.x, dot.y))[1]].type)
            with lock:
                section_progress[4] += 1
    except:
        raise_error("assign_biomes", traceback.format_exc())
def main():
    with multiprocessing.Pool(processes, initializer=initialize_worker,
    initargs=(section_progress, dots, image_sections, lock)) as pool:
        try:
            local_dots = []
            results = pool.map(copy_piece, piece_ranges)
            for result in results:
                local_dots.extend(result)
            biome_origin_dots = [local_dots[i] for i in biome_origin_dot_indexes]
            results = []
            for i in range(processes):
                results.append(pool.apply_async(
                    assign_biomes, (piece_ranges[i], biome_origin_dots, local_dots)))
            [result.wait() for result in results]
        except:
            raise_error("main", traceback.format_exc())